name: Comprehensive CI/CD Pipeline

on:
  push:
  workflow_dispatch:

env:
  MONGODB_VERSION: '7.0'
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # Python Linting and Quality Checks
  # ============================================================================
  python-quality:
    name: Python Linting and Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy pylint pytest pytest-cov
          pip install faker pymongo
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f mongodb-faker-generator/requirements.txt ]; then pip install -r mongodb-faker-generator/requirements.txt; fi

      - name: Lint with flake8
        run: |
          # Only lint Python files if they exist
          if find . -name "*.py" -not -path "./node_modules/*" -not -path "./venv/*" | grep -q .; then
            # Stop on Python syntax errors or undefined names
            flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=node_modules,venv || true
            # Exit-zero treats all errors as warnings
            flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=node_modules,venv || true
          else
            echo "No Python files found to lint"
          fi

      - name: Format check with Black
        run: |
          if find . -name "*.py" -not -path "./node_modules/*" -not -path "./venv/*" | grep -q .; then
            black --check --diff . --exclude="/(node_modules|venv|\.git)/" || true
          else
            echo "No Python files found to format check"
          fi
        continue-on-error: true

      - name: Import sort check with isort
        run: |
          if find . -name "*.py" -not -path "./node_modules/*" -not -path "./venv/*" | grep -q .; then
            isort --check-only --diff . --skip node_modules --skip venv || true
          else
            echo "No Python files found to check imports"
          fi
        continue-on-error: true

  # ============================================================================
  # Python Faker Generator Tests with Coverage
  # ============================================================================
  python-faker-tests:
    name: Python Faker Tests & Coverage
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov faker pymongo
          if [ -f mongodb-faker-generator/requirements.txt ]; then pip install -r mongodb-faker-generator/requirements.txt; fi

      - name: Run Faker Generator Tests with Coverage
        run: |
          if [ -d "mongodb-faker-generator/tests" ]; then
            cd mongodb-faker-generator
            pytest tests/ -v --cov=python --cov-report=xml --cov-report=html --cov-report=term --cov-fail-under=80
          else
            echo "No faker tests found, skipping..."
          fi
        env:
          MONGODB_URI: mongodb://localhost:27017
        continue-on-error: true

      - name: Upload Python Coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          file: ./mongodb-faker-generator/coverage.xml
          flags: python-faker
          name: python-faker-coverage
          token: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # Node.js MongoDB Labs Tests with Coverage
  # ============================================================================
  mongodb-labs-tests:
    name: MongoDB Labs Tests & Coverage
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          npm ci || npm install
          npm install -g mongosh || true

      - name: Run linters and dataset smoke tests
        run: npm test

      - name: Wait for MongoDB to be ready
        run: |
          for i in {1..30}; do
            if mongosh --host 127.0.0.1 --quiet --eval "db.adminCommand({ ping: 1 })" > /dev/null 2>&1; then
              echo "MongoDB is ready"
              exit 0
            fi
            echo "Waiting for MongoDB..."
            sleep 2
          done
          echo "MongoDB did not become ready in time" >&2
          exit 1

      # Lab 01 Tests with Coverage
      - name: Lab 01 - Import and Test with Coverage
        run: |
          cd labs/lab01_intro
          mongosh --host 127.0.0.1 --file import_data.js
          mongosh --host 127.0.0.1 --file test_setup.js
          mongosh --host 127.0.0.1 --file test_queries.js
          if [ -f test_queries.js ]; then
            npx c8 --reporter=lcov --reporter=text node test_queries.js || true
          fi
          cd ../..
        env:
          MONGODB_URI: mongodb://127.0.0.1:27017

      # Lab 02 Tests with Coverage
      - name: Lab 02 - Import and Test with Coverage
        run: |
          cd labs/lab02_modeling
          mongosh --host 127.0.0.1 --file import_data_mongosh.js
          mongosh --host 127.0.0.1 --file queries_mongosh.js
          mongosh --host 127.0.0.1 --file test_queries_mongosh.js
          if [ -f test_queries.js ]; then
            npx c8 --reporter=lcov --reporter=text node test_queries.js || true
          fi
          if [ -f run_all_tests.js ]; then
            npx c8 --reporter=lcov --reporter=text node run_all_tests.js --quick || true
          fi
          cd ../..
        env:
          MONGODB_URI: mongodb://127.0.0.1:27017

      # Lab 03 Tests with Coverage
      - name: Lab 03 - Import and Test with Coverage
        run: |
          cd labs/lab03_queries
          node import_data.js
          npx c8 --reporter=lcov --reporter=text node test_data_integrity.js || true
          cd ../..
        env:
          MONGODB_URI: mongodb://127.0.0.1:27017
          LAB03_LIMIT_MOVIES: 60
          LAB03_LIMIT_THEATERS: 15
          LAB03_LIMIT_USERS: 20
          LAB03_LIMIT_COMMENTS: 100
          LAB03_LIMIT_SESSIONS: 60

      # Lab 04 Tests with Coverage
      - name: Lab 04 - Import and Test with Coverage
        run: |
          cd labs/lab04_aggregation
          node import_data.js
          npx c8 --reporter=lcov --reporter=text node test_lab04.js || true
          cd ../..
        env:
          MONGODB_URI: mongodb://127.0.0.1:27017

      - name: Upload Node.js Coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./labs/*/coverage/lcov.info
          flags: nodejs-labs
          name: nodejs-coverage
          token: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # Performance Benchmarks
  # ============================================================================
  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run Lab 02 Performance Benchmarks
        run: |
          if [ -f labs/lab02_modeling/performance_benchmarks.js ]; then
            cd labs/lab02_modeling
            node import_data.js || true
            node performance_benchmarks.js || true

            # Check benchmark results against thresholds
            if [ -f benchmark_results.json ]; then
              node -e "
                const results = require('./benchmark_results.json');
                const thresholds = results.thresholds || { simple_query: 10, aggregate: 50, complex: 100 };
                let failed = 0;

                results.results.forEach(r => {
                  const avg = parseFloat(r.avgTime);
                  let threshold = thresholds.simple_query;

                  if (r.name.includes('Aggregation')) threshold = thresholds.aggregate;
                  else if (r.name.includes('Complex')) threshold = thresholds.complex;

                  if (avg > threshold * 2) {
                    console.error(\`❌ \${r.name}: \${avg}ms far exceeds threshold of \${threshold}ms\`);
                    failed++;
                  } else if (avg > threshold) {
                    console.warn(\`⚠️  \${r.name}: \${avg}ms exceeds threshold of \${threshold}ms\`);
                  } else {
                    console.log(\`✓ \${r.name}: \${avg}ms within threshold\`);
                  }
                });

                if (failed > 3) {
                  console.error('Too many performance failures');
                  process.exit(1);
                }
              " || true
            fi
            cd ../..
          fi
        env:
          MONGODB_URI: mongodb://127.0.0.1:27017

      - name: Upload Benchmark Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: labs/*/benchmark_results.json

  # ============================================================================
  # Data Integrity Validation
  # ============================================================================
  data-integrity:
    name: Data Integrity Validation
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run Data Integrity Validation
        run: |
          if [ -f labs/lab02_modeling/data_integrity_validator.js ]; then
            cd labs/lab02_modeling
            node import_data.js || true
            node data_integrity_validator.js || true
            cd ../..
          fi
        env:
          MONGODB_URI: mongodb://127.0.0.1:27017

      - name: Upload Validation Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: labs/*/validation_report.json

  # ============================================================================
  # Group Deliverables Integration Tests
  # ============================================================================
  group-deliverables:
    name: Group Deliverables Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Validate Group Structure
        run: |
          node scripts/validate_groups.js || true
        continue-on-error: true

      - name: Run Submission Validator
        run: |
          node group-work/scripts/group_submission_validator.js || true
        continue-on-error: true

  # ============================================================================
  # Code Coverage Summary
  # ============================================================================
  coverage-summary:
    name: Coverage Report (Target >80%)
    needs: [python-faker-tests, mongodb-labs-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate Coverage Summary
        run: |
          echo "# Code Coverage Report" > coverage-summary.md
          echo "" >> coverage-summary.md
          echo "## Target: >80% coverage" >> coverage-summary.md
          echo "" >> coverage-summary.md
          echo "### Status:" >> coverage-summary.md
          echo "- Python Faker: ${{ needs.python-faker-tests.result }}" >> coverage-summary.md
          echo "- Node.js Labs: ${{ needs.mongodb-labs-tests.result }}" >> coverage-summary.md
          echo "" >> coverage-summary.md
          echo "View detailed reports at: https://codecov.io/gh/${{ github.repository }}" >> coverage-summary.md

      - name: Upload Coverage Summary
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: coverage-summary.md
